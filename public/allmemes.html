<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Most popular</title>
    <link href="css/main.css" rel="stylesheet">
</head>
<body onload="lataaKuvat()">

<div class="sivupalkki">
    <h3>Menu</h3>
    <a href="index.html">Home</a>
    <a href="mostpopular.html">Most popular</a>
    <a href="allmemes.html">All memes</a>

</div>


<div class="container" id="otsikko">
    <h1>Wellcome to Memeland</h1>

</div>

<div>

    <form method="POST" action="/logged" name="logged">
        <input type="hidden" name="log" value="0" id="logForm">
    </form>

    <div class="container2">

        <h2 id="hello">Profile name </h2>
        <button id="myBtn3">Sign Up</button>
        <div id="myModal2" class="modal">


            <div class="modal-content">

                <span class="close2">&times;</span>

                <form  method="POST" action="/createAccount" id="createForm" onsubmit="return testPassword()">
                    <label>Username: </label>   <input type="text" name="user" id="us"><br>
                    <label>Password: </label>   <input type="text" name="pw1" id="pw1"><br>
                    <label>Re-type Password:</label> <input type="text" name="pw2" id="pw2"><br>
                    <button onclick="closeModal2()" type="submit" form="createForm" value="Submit" >Create</button>
                </form>
            </div>

        </div>
        <div>
            <button id="myBtn4">Login</button>
            <div id="myModal3" class="modal">


                <div class="modal-content">

                    <span class="close3">&times;</span>

                    <form method="POST" action="/login" id="formLogin">
                        <label>Username:</label> <input type="text" name="user" id="logUser"><br>
                        <label>Password:</label>   <input type="text" name="pw" id="logPw"><br>
                        <label>Aika</label>   <input type="text" name="time" id="logTime"> <br>
                    </form>

                    <button onclick="closeModal3()" type="submit" form="formLogin" value="Submit">Login</button>

                </div>
            </div>
        </div>



        <button style="display:none" id="myBtn">Upload</button>
        <form method="Post" action="/profileLogout" id="form"><input type = "hidden" name ="user" id="logInput" /></form> <button style="display: none" type="submit" form="form" value="Submit" id="nappi2">Logout</button>

        <div id="myModal" class="modal">


            <div class="modal-content">

                <span class="close">&times;</span>

                <form action="/upload" method="post" enctype="multipart/form-data" id="lomake">
                    <label>Kuva, ääni tai video
                        <input type="file" name="kuva" accept="audio/*,video/*,image/*">
                    </label>
                    <br>
                    <input type="text" name="tag" placeholder="tagi">
                    <br>
                    <input type="text" name="kuva_teksti" placeholder="desc">
                    <input type = "hidden" name ="user" id="logUpload" />
                    <button type="submit" onclick="closeModal()">Lähetä</button>
                </form>
            </div>

        </div>
    </div>
</div>
<ul id="result">

</ul>


  <h1> All memes </h1>
  <ul id="mostPopular">
  </ul>



<script src="js/main.js"></script>
</body>

<div>
    <div id="loggaus">
        <h5>CREATE NEW ACCOUNT</h5>
        <h5>LOG IN</h5>
    </div>
<script>



  //lataa kuvat kun sivu avautuu

  const lataaKuvat = function() {
      tarkastaKirjautuneet();
      lataaSuosituimmat();
    //  lataaKaikki();
  };
 // lataaKuvat();

 const lataaSuosituimmat = function(){



   const currentdate = new Date();
   //tämän hetkinen aika
   let datetime = currentdate.getDate() + "/"
       + (currentdate.getMonth()+1)  + "/"
       + currentdate.getFullYear() + " @ "
       + currentdate.getHours() + ":"
       + currentdate.getMinutes() + ":"
       + currentdate.getSeconds();
   console.log(datetime);

   const time = document.getElementById('logTime');
   time.value = datetime;
///////////////////////////////////////////////////////////////////////////////AIKAAA
    let n = 0;
    let num =0
    fetch('/pageLoad').then((response) => {
      return response.json();
    }).then((json) => {
      const polku = 'files/';
  //    lista.innerHTML = '';
      popularUl.innerHTML = ""; //listan nollaus joka latauksella
      console.log("JSON: ",json);

      //laita json järjestykseen tykkäämisten perusteella
      json.sort(function(a, b) {
        return a.tykkaa < b.tykkaa;
      });

      json.sort();
      console.log("New order json: ",json);

      //Tämän loopin sisällä muutetaan formit
      json.forEach(item => {
        n++;

        const like = document.createElement('form');
        const dislike = document.createElement('form');
        const comments = document.createElement('form');
        const report = document.createElement('form');
        const commentArea = document.createElement('ul');
        const views = document.createElement('div');
        const uploadedBy = document.createElement('div');
        const tags = document.createElement('div');















        //CSS ESIMERKKI
        let style = "width: 5% ";


        let reportnappi = "background-color: #2C5364;Color: white;cursor: pointer;";

        let kommenttikentta = "width: 20%";



















        //laita formit like buttoneihin
        like.innerHTML = '<form method="post" action="/like" id="form' + n +
            '"><input type = "text" name ="tykkays" style="'+style+'" id="likeId' + n + '" value="'+item.tykkaa+'" /></form> <button type="submit" style="'+reportnappi+'" form="form' +
            n + '" value="Submit">Like</button>';

        dislike.innerHTML = '<form method="post" action="/dislike" id="dform' + n +
            '"><input type = "text" name ="tykkays"  style="'+style+'" id="dislikeId' + n + '" value="'+item.eitykkaa+'"/></form> <button type="submit" style="'+reportnappi+'" form="dform' +
            n + '" value="Submit">Dislike</button>';

        //Kommentit
        comments.innerHTML = '<form method="post" action="/comment" id="comment' + n +
            '"><input type = "text" name ="comment" style="'+kommenttikentta+'" id="kommentti' + n + '" value=""/></form> <button type="submit" style="'+reportnappi+'" form="comment' +
            n + '" value="Submit">Comment</button>';

        //report
        report.innerHTML = '<form method="post" action="/report" id="report' + n +
            '"><input style="'+style+'" type = "hidden" name ="report" id="reportInput' + n + '" value="'+ n +'"/></form> <button type="submit" style="'+reportnappi+'" form="report' +
            n + '" value="Submit">Report</button>';


        //views
        views.innerHTML = "<div> Views: "+json[num].views+" </div>";

        //uploadDed by
        uploadedBy.innerHTML = "<div> Uploaded by: "+json[num].kayttaja_nimi+" </div>"

        //tags
        tags.innerHTML =  "<div> Tags: "+json[num].tag+"</div>";

        //laita nämä koska innerHTML ei välttämättä toimi kun ne laittaa siihen suoraan
        like.method = 'post';
        like.action = '/like';
        like.id = 'form' + n;

        dislike.method = 'post';
        dislike.action = '/dislike';
        dislike.id = 'dform' + n;

        comments.method = 'post';
        comments.action = '/comment';
        comments.id = 'comment' + n;

        report.method= 'post';
        report.action = '/report';
        report.id = 'report' + n;

        //tee li johon kaikki elementit liitetään
        const li = document.createElement('li');
        const kuva = document.createElement('img');
        kuva.src = polku + json[num].URL;

        //modali
        const openModal = document.createElement('button');
        openModal.innerHTML = '<button id=avaa"'+n+'" onclick=avaaModal('+n+')>Open modal</button>';
        const modal = document.createElement('div');
        modal.innerHTML = createModal(n,json[num].URL,like.innerHTML);




        //Missä järjestyksessä haluat näyttää kuvan alla olevat asiat, vies tags jne.
        li.appendChild(kuva);
        li.appendChild(uploadedBy);
        li.appendChild(views);
        li.appendChild(like);
        li.appendChild(dislike);
        li.appendChild(tags);
        li.appendChild(comments);
        li.appendChild(commentArea);
        li.appendChild(report);
        li.appendChild(openModal);
        li.appendChild(modal);
        const divi = document.createElement('div');
        divi.appendChild(li);
        popularUl.appendChild(divi);



        //muokkaa modalia
        editModal(n,like.innerHTML);

        //otetaan kentistä valuet joita käytetään tykkäyksiin, kommentointiin jne.
        const likeNum = document.getElementById("likeId"+n);
        const dislikeNum = document.getElementById("dislikeId"+n);
        const commentValue = comments.querySelector('input'); //lähetetään koko elementti
        console.log("komentti: "+commentValue);
        //joka kuvan id haetaan tällä
        let i = json[num].kuva_id;

        //laitetaan nappeihin functionit

        //tykkaa
        like.addEventListener('submit', function(event) {
        lahetaLomake2(event,i,likeNum,json);});

        //dislike
        dislike.addEventListener('submit', function(event) {
        lahetaLomake3(event,i,dislikeNum,json);});

        //kommentoi
        comments.addEventListener('submit', function(event) {
        lahetaLomake4(event,i,commentValue,json);});

        //reporttaa kuva
        report.addEventListener('submit', function(event) {
        lahetaLomake5(event,i,json);});

        //päivitä kommentti kenttä
        updateKomments(commentArea,n);

          num++; //num lisätään lopussa, koska JSON alkaa nollasta
      }); //foreach looppi loppuu
    });
  };



 // lataaKuvat();
</script>

</html>
